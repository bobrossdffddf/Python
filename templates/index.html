<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATC Flight Plan Monitor</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        .approval-box {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .approval-box h3 {
            margin-top: 0;
            color: #4CAF50;
            text-align: center;
            border-bottom: 1px solid #4CAF50;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapse-button {
            background: none;
            border: none;
            color: #4CAF50;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }
        .approved-flight {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 5px;
            font-size: 12px;
        }
        .approved-flight input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #4CAF50;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        select, button, input {
            padding: 10px 15px;
            border: 2px solid #555;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff !important;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
            border: none;
        }

        select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        button {
            cursor: pointer;
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
        }
        .map-button {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }
        .map-button:hover {
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .status-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .timezone-display {
            color: #81C784;
            font-weight: 600;
        }
        .flights-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .flight-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
        }
        .flight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: #4CAF50;
        }
        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .flight-callsign {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .flight-time {
            color: #B0BEC5;
            font-size: 14px;
            font-weight: 600;
        }
        .approve-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            transform: scale(1.2);
            accent-color: #4CAF50;
        }
        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .flight-detail {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .flight-detail strong {
            color: #81C784;
        }
        .clearance {
            background: rgba(0, 123, 255, 0.1);
            border-left: 4px solid #007bff;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-line;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        .new-flight {
            border-left: 4px solid #ff9800;
            animation: pulse 2s infinite;
        }
        .arriving-flight {
            border-left: 4px solid #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        .arriving-flight .flight-callsign {
            background: linear-gradient(45deg, #f44336, #e57373);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .distance-highlight {
            background: rgba(255, 235, 59, 0.2) !important;
            border: 2px solid #ffeb3b;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255, 235, 59, 0.5); }
            to { box-shadow: 0 0 15px rgba(255, 235, 59, 0.8); }
        }
        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(255, 152, 0, 0.6);
            }
        }
        .connected { 
            color: #4CAF50; 
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .disconnected { 
            color: #f44336; 
            text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }
        .error { 
            color: #ff9800; 
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #81C784, #A5D6A7);
        }

        /* Map Styles */
        .map-container {
            position: fixed;
            top: 50px;
            left: 50px;
            right: 50px;
            bottom: 50px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 0;
            z-index: 2000;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #4CAF50;
            border-radius: 15px 15px 0 0;
        }

        .close-map-btn {
            background: #f44336;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .map-content {
            height: calc(100% - 60px);
            position: relative;
        }

        #leafletMap {
            height: 100%;
            width: 100%;
        }

        .aircraft-marker {
            background: #4CAF50;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }

        .aircraft-marker.ground {
            background: #ff9800;
        }

        .aircraft-marker.air {
            background: #2196F3;
        }

        .leaflet-popup-content {
            color: #000;
            font-size: 12px;
            line-height: 1.4;
        }

        .leaflet-popup-content strong {
            color: #1976D2;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }

        .aircraft-trail {
            stroke: #4CAF50;
            stroke-width: 2;
            fill: none;
            opacity: 0.7;
        }

        /* Pilot Mode Styles */
        .pilot-mode-container {
            position: fixed;
            top: 50px;
            right: 20px;
            width: 400px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff9800;
            border-radius: 15px;
            padding: 20px;
            z-index: 2500;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            display: none; /* Hidden by default */
            overflow-y: auto;
            color: #fff;
        }
        .pilot-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ff9800;
            padding-bottom: 10px;
        }
        .pilot-mode-header h3 {
            margin: 0;
            color: #ff9800;
            font-size: 20px;
        }
        .close-pilot-mode-btn {
            background: #f44336;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .pilot-mode-content label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }
        .pilot-mode-content input[type="text"],
        .pilot-mode-content textarea,
        .pilot-mode-content button {
            width: calc(100% - 20px);
            margin-bottom: 15px;
            padding: 12px 10px;
            border: 1px solid #555;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            backdrop-filter: blur(5px);
        }
        .pilot-mode-content textarea {
            min-height: 100px;
            resize: vertical;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .pilot-mode-content button {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
        }
        .pilot-mode-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }
        .route-info, .clearance-section, .utility-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .route-info h4, .clearance-section h4, .utility-section h4 {
            margin-top: 0;
            color: #ff9800;
            border-bottom: 1px solid #ff9800;
            padding-bottom: 8px;
        }
        .route-details span, .utility-buttons button {
            margin-right: 10px;
            font-size: 12px;
        }
        .utility-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .utility-buttons button {
            padding: 8px 12px;
            font-size: 12px;
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
        }
        .utility-buttons button:hover {
            background: rgba(255, 152, 0, 0.4);
            box-shadow: none;
            transform: none;
        }

        /* Map button in controls */
        .controls button.map-button {
            background: linear-gradient(45deg, #00bcd4, #00acc1);
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
        }
        .controls button.map-button:hover {
            box-shadow: 0 8px 25px rgba(0, 188, 212, 0.4);
        }

        /* Pilot mode button in controls */
        .controls button.pilot-mode-button {
            background: linear-gradient(45deg, #ffeb3b, #fbc02d);
            box-shadow: 0 4px 15px rgba(255, 235, 59, 0.3);
            color: #333; /* Darker text for contrast */
        }
        .controls button.pilot-mode-button:hover {
            box-shadow: 0 8px 25px rgba(255, 235, 59, 0.4);
        }

    </style>
</head>
<body>
    <div class="approval-box" id="approvalBox">
        <h3>✅ Approved Flights <button class="collapse-button" onclick="toggleApprovalBox()"><span id="collapseIcon">▼</span></button></h3>
        <div id="approvedFlights">
            <p style="text-align: center; color: #888; font-size: 12px;">No approvals yet...</p>
        </div>
    </div>

    <div class="header">
        <h1>🛩️ ATC Flight Plan Monitor</h1>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>🛬 Runway:</label>
            <input type="text" id="runwayInput" placeholder="e.g., 09L" maxlength="3" style="width: 80px;">
        </div>
        <div class="control-group">
            <label>🏢 Airport Filter:</label>
            <select id="airportFilter">
                <option value="">All Airports</option>
                <option value="IBAR">IBAR</option>
                <option value="IHEN">IHEN</option>
                <option value="ILAR">ILAR</option>
                <option value="IIAB">IIAB</option>
                <option value="IPAP">IPAP</option>
                <option value="IGRV">IGRV</option>
                <option value="IJAF">IJAF</option>
                <option value="IZOL">IZOL</option>
                <option value="ISCM">ISCM</option>
                <option value="IDCS">IDCS</option>
                <option value="ITKO">ITKO</option>
                <option value="ILKL">ILKL</option>
                <option value="IPPH">IPPH</option>
                <option value="IGAR">IGAR</option>
                <option value="IBLT">IBLT</option>
                <option value="IRFD">IRFD</option>
                <option value="IMLR">IMLR</option>
                <option value="ITRC">ITRC</option>
                <option value="IBTH">IBTH</option>
                <option value="IUFO">IUFO</option>
                <option value="ISAU">ISAU</option>
                <option value="ISKP">ISKP</option>
            </select>
        </div>
        <button onclick="clearHistory()">🗑️ Clear History</button>
        <button class="map-button" onclick="openMap()">🗺️ Live Map</button>
        <button class="pilot-mode-button" onclick="openPilotMode()">🧑‍✈️ Pilot Mode</button>
    </div>

    <div class="status">
        <div class="status-item">
            <div>Status: <span id="connectionStatus" class="disconnected">Disconnected</span></div>
        </div>
        <div class="status-item">
            <div>Total Flights: <span id="totalFlights">0</span></div>
        </div>
        <div class="status-item">
            <div>Filtered Flights: <span id="filteredFlights">0</span></div>
        </div>
        <div class="status-item timezone-display">
            <div>🌍 Your Timezone: <span id="userTimezone"></span></div>
        </div>
    </div>

    <!-- Map Container (initially hidden) -->
    <div id="mapContainer" class="map-container" style="display: none;">
        <div class="map-header">
            <h3>🗺️ Live ATC Map - PTFS</h3>
            <button onclick="closeMap()" class="close-map-btn">✖️</button>
        </div>
        <div class="map-content">
            <div id="leafletMap"></div>
            <div class="map-controls">
                <div>🛩️ Aircraft: <span id="aircraftCount">0</span></div>
                <div>🔄 Last Update: <span id="lastUpdate">Never</span></div>
            </div>
        </div>
    </div>

    <!-- Pilot Mode Container (initially hidden) -->
    <div id="pilotContainer" class="pilot-mode-container">
        <div class="pilot-mode-header">
            <h3>🧑‍✈️ Pilot Mode Tools</h3>
            <button onclick="closePilotMode()" class="close-pilot-mode-btn">✖️</button>
        </div>
        <div class="pilot-mode-content">
            <div class="route-info">
                <h4>Route Information</h4>
                <label for="routeInput">Enter Route (e.g., IGRV-IBAR):</label>
                <input type="text" id="routeInput" placeholder="DEPARTURE-ARRIVAL">
                <div class="route-details" style="text-align: center; margin-top: 10px;">
                    Departure: <span id="depAirport">-</span> | Arrival: <span id="arrAirport">-</span> | Distance: <span id="routeDistance">-</span> | Est. Time: <span id="routeTime">-</span>
                </div>
                <div id="routeMap" style="height: 150px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 15px;">
                    <p style="text-align: center; padding-top: 60px; color: #ccc;">Enter a route to visualize</p>
                </div>
                <div class="utility-buttons" style="margin-top: 15px;">
                    <button onclick="generateRouteMap()">Update Route</button>
                    <button onclick="copyCoordinates()">Copy Coordinates</button>
                    <button onclick="calculateFuelBurn()">Fuel Calc</button>
                    <button onclick="getWeatherInfo()">Weather</button>
                    <button onclick="calculateETA()">Calc ETA</button>
                    <button onclick="getAltitudeAdvice()">Altitude Advice</button>
                    <button onclick="exportFlightPlan()">Export Plan</button>
                </div>
            </div>
            <div class="clearance-section">
                <h4>Active Clearances</h4>
                <textarea id="activeClearances" readonly placeholder="Clearances will appear here based on selected route or filtered flights..."></textarea>
                <div class="utility-buttons">
                    <button onclick="copyClearances()">Copy Clearances</button>
                </div>
            </div>
            <div class="utility-section">
                <h4>General Utilities</h4>
                <div class="utility-buttons">
                    <button onclick="getInstructions()">View Instructions</button>
                    <button onclick="copyInstructions()">Copy Instructions</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flights-container">
        <div id="flightsList">
            <p style="text-align: center; color: #888;">No flight plans yet...</p>
        </div>
    </div>

    <script>
        let currentFilter = '';
        let flights = [];
        let lastFlightCount = 0;
        let approvedFlights = new Set();
        let userTimezone = '';
        let isApprovalBoxCollapsed = false;
        let aircraftData = {};
        let isMapOpen = false;
        let map = null;
        let aircraftMarkers = {};
        let aircraftTrails = {};
        let isPilotModeOpen = false; // State for pilot mode

        // Dummy data for AIRPORT_COORDINATES for route calculations
        const AIRPORT_COORDINATES = {
            "IBAR": {"x":-500, "z":-200}, "IHEN": {"x":-300, "z":-150}, "ILAR": {"x":-600, "z":-300},
            "IIAB": {"x":-100, "z":-50}, "IPAP": {"x":-800, "z":-500}, "IGRV": {"x":-400, "z":-250},
            "IJAF": {"x":-900, "z":-600}, "IZOL": {"x":-1000, "z":-700}, "ISCM": {"x":-1100, "z":-800},
            "IDCS": {"x":-200, "z":-100}, "ITKO": {"x":-700, "z":-400}, "ILKL": {"x":-1200, "z":-900},
            "IPPH": {"x":-1300, "z":-1000}, "IGAR": {"x":-1400, "z":-1100}, "IBLT": {"x":-1500, "z":-1200},
            "IRFD": {"x":-1600, "z":-1300}, "IMLR": {"x":-1700, "z":-1400}, "ITRC": {"x":-1800, "z":-1500},
            "IBTH": {"x":-1900, "z":-1600}, "IUFO": {"x":-2000, "z":-1700}, "ISAU": {"x":-2100, "z":-1800},
            "ISKP": {"x":-2200, "z":-1900}
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set user's timezone
            userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('userTimezone').textContent = userTimezone;

            const airportFilter = document.getElementById('airportFilter');
            airportFilter.addEventListener('change', function() {
                currentFilter = this.value;
                setAirportFilter(currentFilter);
                displayFlights();
            });

            // Handle runway input changes
            const runwayInput = document.getElementById('runwayInput');
            runwayInput.addEventListener('input', function() {
                updateRunwayForAllFlights(this.value);
            });

            // Handle route input changes for pilot mode
            document.getElementById('routeInput').addEventListener('input', function() {
                // Clear previous route info if input changes before generating
                if (this.value.trim() === '') {
                    document.getElementById('depAirport').textContent = '-';
                    document.getElementById('arrAirport').textContent = '-';
                    document.getElementById('routeDistance').textContent = '-';
                    document.getElementById('routeTime').textContent = '-';
                    document.getElementById('routeMap').innerHTML = '<p style="text-align: center; padding-top: 60px; color: #ccc;">Enter a route to visualize</p>';
                }
            });

            // Start polling for updates
            setInterval(updateData, 2000);
            updateData();
        });

        function formatTimeInUserTimezone(timestamp) {
            const now = new Date();
            const today = now.toDateString();
            const flightTime = new Date(today + ' ' + timestamp);

            return flightTime.toLocaleTimeString([], {
                timeZone: userTimezone,
                hour12: true,
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function updateData() {
            try {
                // Get flights
                const flightsResponse = await fetch('/api/flights');
                const newFlights = await flightsResponse.json();

                // Check for new flights to monitored airport
                if (currentFilter && newFlights.length > lastFlightCount) {
                    const newFlightPlans = newFlights.slice(lastFlightCount);
                    for (const flight of newFlightPlans) {
                        if (flight.departing === currentFilter || flight.arriving === currentFilter) {
                            playNotificationSound();
                            // Mark as new flight
                            flight.isNew = true;
                            setTimeout(() => {
                                flight.isNew = false;
                                displayFlights();
                            }, 5000);
                        }
                    }
                }

                flights = newFlights;
                lastFlightCount = flights.length;

                // Get status
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();

                // Get aircraft data for map
                const aircraftResponse = await fetch('/api/aircraft');
                aircraftData = await aircraftResponse.json();

                updateStatus(status);
                displayFlights();
                updateAircraftMap();
            } catch (error) {
                console.error('Error updating data:', error);
            }
        }

        function updateStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status.connection_status;
            statusElement.className = status.connection_status.toLowerCase();

            document.getElementById('totalFlights').textContent = status.total_flights;
        }

        function displayFlights() {
            const flightsList = document.getElementById('flightsList');
            let filteredFlights = flights;

            if (currentFilter) {
                filteredFlights = flights.filter(flight => 
                    flight.departing === currentFilter || flight.arriving === currentFilter
                );
            }

            document.getElementById('filteredFlights').textContent = filteredFlights.length;

            if (filteredFlights.length === 0) {
                flightsList.innerHTML = '<p style="text-align: center; color: #888;">No flight plans match your filter...</p>';
                return;
            }

            flightsList.innerHTML = filteredFlights.reverse().map(flight => {
                const isArrivingToFilter = flight.is_arriving_to_filter || false;
                const clearanceSection = flight.clearance ? `
                    <div class="clearance">
                        <strong>📋 Clearance:</strong><br>
                        ${flight.clearance}
                    </div>
                ` : '';

                // Distance sections for departing and arriving airports
                const departingDistanceSection = flight.distance_to_departing ? `
                    <div class="flight-detail distance-highlight">
                        <strong>📏 Distance from ${flight.departing}:</strong><br>${flight.distance_to_departing.toLocaleString()} feet
                    </div>
                ` : '';

                const arrivingDistanceSection = flight.distance_to_arriving ? `
                    <div class="flight-detail distance-highlight">
                        <strong>📏 Distance to ${flight.arriving}:</strong><br>${flight.distance_to_arriving.toLocaleString()} feet
                    </div>
                ` : '';

                return `
                <div class="flight-card ${flight.isNew ? 'new-flight' : ''} ${isArrivingToFilter ? 'arriving-flight' : ''}">
                    <input type="checkbox" class="approve-checkbox" onchange="toggleApproval('${flight.callsign}', this.checked)" ${approvedFlights.has(flight.callsign) ? 'checked' : ''}>
                    <div class="flight-header">
                        <div class="flight-callsign">${flight.callsign}</div>
                        <div class="flight-time">${formatTimeInUserTimezone(flight.timestamp)}</div>
                    </div>
                    <div class="flight-details">
                        <div class="flight-detail">
                            <strong>✈️ Aircraft:</strong><br>${flight.aircraft}
                        </div>
                        <div class="flight-detail">
                            <strong>🛫 Departing:</strong><br>${flight.departing}
                        </div>
                        <div class="flight-detail">
                            <strong>🛬 Arriving:</strong><br>${flight.arriving}
                        </div>
                        <div class="flight-detail">
                            <strong>📊 Flight Level:</strong><br>FL${flight.flightlevel}
                        </div>
                        <div class="flight-detail">
                            <strong>🗺️ Route:</strong><br>${flight.route || 'N/A'}
                        </div>
                        ${departingDistanceSection}
                        ${arrivingDistanceSection}
                    </div>
                    ${clearanceSection}
                </div>
            `}).join('');
        }

        function toggleApproval(callsign, isChecked) {
            if (isChecked) {
                approvedFlights.add(callsign);
            } else {
                approvedFlights.delete(callsign);
            }
            updateApprovalBox();
        }

        function updateApprovalBox() {
            const approvedFlightsDiv = document.getElementById('approvedFlights');

            if (approvedFlights.size === 0) {
                approvedFlightsDiv.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">No approvals yet...</p>';
                return;
            }

            approvedFlightsDiv.innerHTML = Array.from(approvedFlights).map(callsign => `
                <div class="approved-flight">
                    <input type="checkbox" checked disabled>
                    <span>${callsign}</span>
                </div>
            `).join('');
        }

        function toggleApprovalBox() {
            const approvalBoxContent = document.getElementById('approvedFlights');
            const collapseIcon = document.getElementById('collapseIcon');

            if (isApprovalBoxCollapsed) {
                approvalBoxContent.style.display = 'block';
                collapseIcon.textContent = '▼';
            } else {
                approvalBoxContent.style.display = 'none';
                collapseIcon.textContent = '▶';
            }
            isApprovalBoxCollapsed = !isApprovalBoxCollapsed;
        }

        async function setAirportFilter(airport) {
            try {
                await fetch('/api/set_airport_filter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ airport_code: airport })
                });
            } catch (error) {
                console.error('Error setting filter:', error);
            }
        }

        async function updateRunwayForAllFlights(runway) {
            if (!runway) runway = '___';

            try {
                await fetch('/api/update_runway', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ runway: runway })
                });
                // Refresh the display
                displayFlights();
            } catch (error) {
                console.error('Error updating runway:', error);
            }
        }

        async function clearHistory() {
            if (confirm('Are you sure you want to clear the flight history?')) {
                try {
                    await fetch('/api/clear_history', { method: 'POST' });
                    flights = [];
                    displayFlights();
                } catch (error) {
                    console.error('Error clearing history:', error);
                }
            }
        }



        function playNotificationSound() {
            try {
                // Create a pleasant beeping notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // First beep
                const oscillator1 = audioContext.createOscillator();
                const gainNode1 = audioContext.createGain();

                oscillator1.connect(gainNode1);
                gainNode1.connect(audioContext.destination);

                oscillator1.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator1.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.2);

                // Second beep
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();

                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);

                oscillator2.frequency.setValueAtTime(1000, audioContext.currentTime + 0.3);
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.3);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator2.start(audioContext.currentTime + 0.3);
                oscillator2.stop(audioContext.currentTime + 0.5);

                console.log('Notification sound played');
            } catch (error) {
                console.error('Error playing notification sound:', error);
                // Fallback: try to use system beep if available
                if (typeof Audio !== 'undefined') {
                    try {
                        // Create a simple audio fallback
                        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAeBC2Ozey2bSEFl9oJhUQ=');
                        audio.play().catch(() => {}); // Silent fail
                    } catch (e) {}
                }
            }
        }

        function openMap() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'block';
            isMapOpen = true;

            if (!map) {
                initializeMap();
            }

            // Refresh the map size and update aircraft
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    updateAircraftMap();
                }
            }, 100);
        }

        function closeMap() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'none';
            isMapOpen = false;
        }

        function initializeMap() {
            // Initialize the map centered on a general aviation area
            map = L.map('leafletMap').setView([25.0, -80.0], 8);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add a secondary satellite layer option
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });

            // Custom map overlays
            const customOverlays = {};

            // Load custom SVG overlay if available
            try {
                const svgOverlay = L.svgOverlay('/static/maps/example_airport.svg', [[25.0, -80.2], [25.1, -80.0]]);
                customOverlays["Example Airport Layout"] = svgOverlay;
            } catch (e) {
                console.log('No custom SVG overlay found');
            }

            // Layer control
            const baseMaps = {
                "Street Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }),
                "Satellite": satelliteLayer
            };

            L.control.layers(baseMaps, customOverlays).addTo(map);

            // Add PTFS airports as markers
            const airports = [
                {name: 'IBAR', lat: 25.7617, lng: -80.1918, desc: 'Barra Airport'},
                {name: 'IHEN', lat: 25.7753, lng: -80.1348, desc: 'Henderson Airport'},
                {name: 'ILAR', lat: 25.7889, lng: -80.2264, desc: 'Larnaca Airport'},
                {name: 'IIAB', lat: 25.8067, lng: -80.0969, desc: 'IAB Airport'},
                {name: 'IPAP', lat: 25.6586, lng: -80.2878, desc: 'Paphos Airport'},
                {name: 'IGRV', lat: 25.9123, lng: -80.1456, desc: 'Grove Airport'},
                {name: 'IJAF', lat: 25.5434, lng: -80.3421, desc: 'Jaffa Airport'},
                {name: 'IZOL', lat: 25.7234, lng: -80.4123, desc: 'Zola Airport'},
                {name: 'ISCM', lat: 25.8234, lng: -80.3567, desc: 'SCM Airport'},
                {name: 'IDCS', lat: 25.6789, lng: -80.0234, desc: 'DCS Airport'},
                {name: 'ITKO', lat: 25.9876, lng: -80.2345, desc: 'TKO Airport'},
                {name: 'ILKL', lat: 25.4567, lng: -80.1789, desc: 'LKL Airport'},
                {name: 'IPPH', lat: 25.8901, lng: -80.4567, desc: 'PPH Airport'},
                {name: 'IGAR', lat: 25.3456, lng: -80.2890, desc: 'Garfield Airport'},
                {name: 'IBLT', lat: 25.7890, lng: -80.0456, desc: 'BLT Airport'},
                {name: 'IRFD', lat: 25.6123, lng: -80.3789, desc: 'RFD Airport'},
                {name: 'IMLR', lat: 25.9234, lng: -80.1234, desc: 'MLR Airport'},
                {name: 'ITRC', lat: 25.4789, lng: -80.4012, desc: 'TRC Airport'},
                {name: 'IBTH', lat: 25.8567, lng: -80.2678, desc: 'BTH Airport'},
                {name: 'IUFO', lat: 25.7345, lng: -80.3456, desc: 'UFO Airport'},
                {name: 'ISAU', lat: 25.5678, lng: -80.0789, desc: 'SAU Airport'},
                {name: 'ISKP', lat: 25.8012, lng: -80.4234, desc: 'SKP Airport'}
            ];

            airports.forEach(airport => {
                const airportIcon = L.divIcon({
                    className: 'airport-marker',
                    html: `<div style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">${airport.name}</div>`,
                    iconSize: [40, 20],
                    iconAnchor: [20, 10]
                });

                L.marker([airport.lat, airport.lng], {icon: airportIcon})
                 .addTo(map)
                 .bindPopup(`<strong>${airport.name}</strong><br>${airport.desc}`);
            });
        }

        function convertPTFSToLatLng(ptfsX, ptfsY) {
            // Convert PTFS coordinates to lat/lng
            // This is an approximation - you may need to adjust based on actual PTFS coordinate system
            const centerLat = 25.7617;
            const centerLng = -80.1918;
            const scale = 0.001; // Adjust this scale factor as needed

            const lat = centerLat + (ptfsY * scale);
            const lng = centerLng + (ptfsX * scale);

            return [lat, lng];
        }

        function updateAircraftMap() {
            if (!isMapOpen || !map) return;

            const aircraftCount = Object.keys(aircraftData).length;
            document.getElementById('aircraftCount').textContent = aircraftCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            if (aircraftCount === 0) return;

            // Clear old markers that are no longer in the data
            Object.keys(aircraftMarkers).forEach(callsign => {
                if (!aircraftData[callsign]) {
                    map.removeLayer(aircraftMarkers[callsign]);
                    delete aircraftMarkers[callsign];

                    if (aircraftTrails[callsign]) {
                        map.removeLayer(aircraftTrails[callsign]);
                        delete aircraftTrails[callsign];
                    }
                }
            });

            // Update or create markers for each aircraft
            Object.entries(aircraftData).forEach(([callsign, data]) => {
                if (!data.position) return;

                const [lat, lng] = convertPTFSToLatLng(data.position.x, data.position.z || data.position.y);

                // Create or update marker
                if (aircraftMarkers[callsign]) {
                    // Update existing marker position
                    aircraftMarkers[callsign].setLatLng([lat, lng]);
                } else {
                    // Create new marker
                    const isOnGround = data.isOnGround || (data.altitude && data.altitude < 100);
                    const markerColor = isOnGround ? '#ff9800' : '#2196F3';

                    const aircraftIcon = L.divIcon({
                        className: 'aircraft-marker',
                        html: `<div style="background: ${markerColor}; border: 2px solid white; border-radius: 50%; width: 12px; height: 12px; transform: rotate(${data.heading || 0}deg);"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });

                    const marker = L.marker([lat, lng], {icon: aircraftIcon}).addTo(map);

                    // Create popup with aircraft info
                    const popupContent = `
                        <strong>${callsign}</strong><br>
                        <strong>Pilot:</strong> ${data.playerName || 'Unknown'}<br>
                        <strong>Aircraft:</strong> ${data.aircraftType || 'Unknown'}<br>
                        <strong>Altitude:</strong> ${data.altitude ? Math.round(data.altitude) + ' ft' : 'Unknown'}<br>
                        <strong>Heading:</strong> ${data.heading || 'Unknown'}°<br>
                        <strong>Speed:</strong> ${data.speed ? Math.round(data.speed) + ' kts' : 'Unknown'}<br>
                        <strong>Ground Speed:</strong> ${data.groundSpeed ? Math.round(data.groundSpeed) + ' kts' : 'Unknown'}<br>
                        <strong>On Ground:</strong> ${isOnGround ? 'Yes' : 'No'}
                    `;

                    marker.bindPopup(popupContent);
                    aircraftMarkers[callsign] = marker;
                }

                // Update marker popup
                const isOnGround = data.isOnGround || (data.altitude && data.altitude < 100);
                const popupContent = `
                    <strong>${callsign}</strong><br>
                    <strong>Pilot:</strong> ${data.playerName || 'Unknown'}<br>
                    <strong>Aircraft:</strong> ${data.aircraftType || 'Unknown'}<br>
                    <strong>Altitude:</strong> ${data.altitude ? Math.round(data.altitude) + ' ft' : 'Unknown'}<br>
                    <strong>Heading:</strong> ${data.heading || 'Unknown'}°<br>
                    <strong>Speed:</strong> ${data.speed ? Math.round(data.speed) + ' kts' : 'Unknown'}<br>
                    <strong>Ground Speed:</strong> ${data.groundSpeed ? Math.round(data.groundSpeed) + ' kts' : 'Unknown'}<br>
                    <strong>On Ground:</strong> ${isOnGround ? 'Yes' : 'No'}
                `;
                aircraftMarkers[callsign].setPopupContent(popupContent);
            });
        }

        // Pilot Mode Functions
        function openPilotMode() {
            const pilotContainer = document.getElementById('pilotContainer');
            pilotContainer.style.display = 'block';
            isPilotModeOpen = true;

            // Load active clearances from current flights
            updateActiveClearances();
        }

        function closePilotMode() {
            const pilotContainer = document.getElementById('pilotContainer');
            pilotContainer.style.display = 'none';
            isPilotModeOpen = false;
        }

        function updateActiveClearances() {
            const clearancesDiv = document.getElementById('activeClearances');
            let clearanceText = '';

            // Get clearances from filtered flights
            let relevantFlights = flights;
            if (currentFilter) {
                relevantFlights = flights.filter(flight => 
                    flight.departing === currentFilter || flight.arriving === currentFilter
                );
            }

            if (relevantFlights.length === 0) {
                clearanceText = 'No active clearances. Select a flight from the main page to view clearances here.';
            } else {
                relevantFlights.slice(-5).forEach(flight => {
                    if (flight.clearance) {
                        clearanceText += `${flight.callsign} (${flight.timestamp}):\n${flight.clearance}\n\n`;
                    }
                });
            }

            clearancesDiv.textContent = clearanceText || 'No clearances available.';
        }

        function generateRouteMap() {
            const routeInput = document.getElementById('routeInput').value.trim();
            const routeMapDiv = document.getElementById('routeMap');

            if (!routeInput) {
                routeMapDiv.textContent = 'Please enter a route (e.g., IGRV-IBAR)';
                return;
            }

            const routeParts = routeInput.split('-');
            if (routeParts.length < 2) {
                routeMapDiv.textContent = 'Invalid route format. Use format: DEPARTURE-ARRIVAL';
                return;
            }

            const departure = routeParts[0].trim().toUpperCase();
            const arrival = routeParts[1].trim().toUpperCase();

            // Update route information
            document.getElementById('depAirport').textContent = departure;
            document.getElementById('arrAirport').textContent = arrival;

            // Calculate distance if airports exist
            if (AIRPORT_COORDINATES[departure] && AIRPORT_COORDINATES[arrival]) {
                const depCoords = AIRPORT_COORDINATES[departure];
                const arrCoords = AIRPORT_COORDINATES[arrival];

                const dx = arrCoords.x - depCoords.x;
                const dy = arrCoords.z - depCoords.z;
                const distanceStuds = Math.sqrt(dx*dx + dy*dy);
                const distanceNM = distanceStuds / 3307.14286; // Convert to nautical miles

                document.getElementById('routeDistance').textContent = `${Math.round(distanceNM)} NM`;

                // Estimate flight time (assuming 300 knots average)
                const timeHours = distanceNM / 300;
                const hours = Math.floor(timeHours);
                const minutes = Math.round((timeHours - hours) * 60);
                document.getElementById('routeTime').textContent = `${hours}h ${minutes}m`;
            }

            // Create simple route visualization
            routeMapDiv.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 80%; margin-bottom: 20px;">
                        <div style="background: #4CAF50; padding: 10px; border-radius: 5px; color: white; font-weight: bold;">
                            🛫 ${departure}
                        </div>
                        <div style="flex: 1; height: 2px; background: linear-gradient(90deg, #4CAF50, #f44336); margin: 0 20px; position: relative;">
                            <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #ff9800; padding: 5px; border-radius: 3px; font-size: 10px;">
                                ✈️ Route
                            </div>
                        </div>
                        <div style="background: #f44336; padding: 10px; border-radius: 5px; color: white; font-weight: bold;">
                            🛬 ${arrival}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #ccc; text-align: center;">
                        Route: ${departure} → ${arrival}<br>
                        Click "Copy Coordinates" for detailed waypoints
                    </div>
                </div>
            `;
        }

        function copyClearances() {
            const clearancesText = document.getElementById('activeClearances').textContent;
            navigator.clipboard.writeText(clearancesText).then(() => {
                alert('Clearances copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy clearances:', err);
            });
        }

        function calculateFuelBurn() {
            const routeInput = document.getElementById('routeInput').value.trim();
            if (!routeInput) {
                alert('Please enter a route first!');
                return;
            }

            const routeParts = routeInput.split('-');
            if (routeParts.length >= 2) {
                const departure = routeParts[0].trim().toUpperCase();
                const arrival = routeParts[1].trim().toUpperCase();

                if (AIRPORT_COORDINATES[departure] && AIRPORT_COORDINATES[arrival]) {
                    const depCoords = AIRPORT_COORDINATES[departure];
                    const arrCoords = AIRPORT_COORDINATES[arrival];

                    const dx = arrCoords.x - depCoords.x;
                    const dy = arrCoords.z - depCoords.z;
                    const distanceStuds = Math.sqrt(dx*dx + dy*dy);
                    const distanceNM = distanceStuds / 3307.14286;

                    // Rough fuel calculation (gallons per hour for typical aircraft)
                    const avgFuelBurn = 25; // gallons per hour
                    const avgSpeed = 300; // knots
                    const flightTime = distanceNM / avgSpeed;
                    const fuelNeeded = flightTime * avgFuelBurn;
                    const fuelWithReserve = fuelNeeded * 1.3; // 30% reserve

                    alert(`Fuel Calculation for ${departure} → ${arrival}:\n\nDistance: ${Math.round(distanceNM)} NM\nFlight Time: ${Math.round(flightTime * 60)} minutes\nFuel Required: ${Math.round(fuelNeeded)} gallons\nWith 30% Reserve: ${Math.round(fuelWithReserve)} gallons`);
                } else {
                    alert('Unknown airport in route. Please check airport codes.');
                }
            }
        }

        function getWeatherInfo() {
            alert('Weather Information:\n\n• Check current METAR/TAF reports\n• Monitor wind conditions at departure/arrival\n• Review visibility and ceiling requirements\n• Check for any weather-related NOTAMs\n• Consider alternate airports if needed\n\nNote: This is a simulation - check real weather services for actual flights.');
        }

        function calculateETA() {
            const routeInput = document.getElementById('routeInput').value.trim();
            if (!routeInput) {
                alert('Please enter a route first!');
                return;
            }

            const now = new Date();
            const etaText = document.getElementById('routeTime').textContent;

            if (etaText && etaText !== '-') {
                const timeMatch = etaText.match(/(\d+)h (\d+)m/);
                if (timeMatch) {
                    const hours = parseInt(timeMatch[1]);
                    const minutes = parseInt(timeMatch[2]);

                    const eta = new Date(now.getTime() + (hours * 60 + minutes) * 60 * 1000);
                    alert(`ETA Calculation:\n\nDeparture Time: ${now.toLocaleTimeString()}\nFlight Duration: ${etaText}\nEstimated Arrival: ${eta.toLocaleTimeString()}\n\nNote: Add taxi time and potential delays.`);
                }
            } else {
                alert('Please generate a route map first to calculate ETA.');
            }
        }

        function getAltitudeAdvice() {
            alert('Altitude Planning Advice:\n\n• IFR Eastbound: Odd thousands (3000, 5000, 7000...)\n• IFR Westbound: Even thousands (4000, 6000, 8000...)\n• VFR Eastbound: Odd + 500 (3500, 5500, 7500...)\n• VFR Westbound: Even + 500 (4500, 6500, 8500...)\n\n• Consider winds aloft for optimal cruise altitude\n• Check MEA/MOCA for terrain clearance\n• Plan step climbs for long flights\n• Consider icing levels and turbulence reports');
        }

        function exportFlightPlan() {
            const routeInput = document.getElementById('routeInput').value.trim();
            if (!routeInput) {
                alert('Please enter a route first!');
                return;
            }

            const departure = document.getElementById('depAirport').textContent;
            const arrival = document.getElementById('arrAirport').textContent;
            const distance = document.getElementById('routeDistance').textContent;
            const time = document.getElementById('routeTime').textContent;

            const flightPlan = `FLIGHT PLAN\n\nRoute: ${routeInput}\nDeparture: ${departure}\nArrival: ${arrival}\nDistance: ${distance}\nEstimated Time: ${time}\n\nGenerated: ${new Date().toLocaleString()}\nSource: ATC Flight Plan Monitor`;

            navigator.clipboard.writeText(flightPlan).then(() => {
                alert('Flight plan exported to clipboard!');
            }).catch(err => {
                console.error('Failed to export flight plan:', err);
            });
        }

        function copyCoordinates() {
            const departure = document.getElementById('depAirport').textContent;
            const arrival = document.getElementById('arrAirport').textContent;

            if (departure === '-' || arrival === '-') {
                alert('Please generate a route map first!');
                return;
            }

            let coordText = `ROUTE COORDINATES\n\n`;

            if (AIRPORT_COORDINATES[departure]) {
                const depCoords = AIRPORT_COORDINATES[departure];
                coordText += `${departure}: X=${depCoords.x}, Z=${depCoords.z}\n`;
            }

            if (AIRPORT_COORDINATES[arrival]) {
                const arrCoords = AIRPORT_COORDINATES[arrival];
                coordText += `${arrival}: X=${arrCoords.x}, Z=${arrCoords.z}\n`;
            }

            coordText += `\nGenerated: ${new Date().toLocaleString()}`;

            navigator.clipboard.writeText(coordText).then(() => {
                alert('Coordinates copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy coordinates:', err);
            });
        }

        // Mock functions for pilot mode utilities
        function getInstructions() {
            alert("Pilot Mode Instructions:\n\n1. Enter your flight route (e.g., IGRV-IBAR) in the 'Route' field.\n2. Click 'Update Route' to see route details, distance, and estimated time.\n3. Use the buttons below the route to copy coordinates, calculate fuel, get weather info, estimate ETA, review altitude advice, and export your flight plan.\n4. The 'Active Clearances' section will show clearances for recent flights, which you can copy.\n5. Use the 'General Utilities' for additional pilot-specific information.");
        }

        function copyInstructions() {
            const instructions = "Pilot Mode Instructions:\n\n1. Enter your flight route (e.g., IGRV-IBAR) in the 'Route' field.\n2. Click 'Update Route' to see route details, distance, and estimated time.\n3. Use the buttons below the route to copy coordinates, calculate fuel, get weather info, estimate ETA, review altitude advice, and export your flight plan.\n4. The 'Active Clearances' section will show clearances for recent flights, which you can copy.\n5. Use the 'General Utilities' for additional pilot-specific information.";
            navigator.clipboard.writeText(instructions).then(() => {
                alert('Instructions copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy instructions:', err);
            });
        }

        // Update pilot mode when data refreshes
        const originalUpdateData = updateData;
        updateData = async function() {
            await originalUpdateData();
            if (isPilotModeOpen) {
                updateActiveClearances();
            }
        }
    </script>
</body>
</html>